  <!DOCTYPE html>
  <html>
  <head>
    <meta property="og:url"                content="http://cohi.neocities.org/" />
    <meta property="og:title"              content="COHI - Community Online Haze Index" />
    <meta property="og:type"               content="website" />
    <meta property="og:description"        content="Read PM2.5 spot readings contributed by volunteers" />
    <meta property="og:image"              content="http://cohi.neocities.org/fbPreview.png" />
    <meta property="og:image:width"        content="1848" />
    <meta property="og:image:height"       content="970" />
    <link href='https://fonts.googleapis.com/css?family=Shadows+Into+Light' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Lora' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:900' rel='stylesheet' type='text/css'>
    <style type="text/css">
        html, body { height: 100%; margin: 0; padding: 0; }
        h1, h2, h3 { margin: auto; font-family: 'Shadows Into Light', cursive; }
        #map { 
          width: 720px;
          height: 405px; 
          margin: auto;
          width: 60%;
          border: 3px solid #8AC007;
          padding: 10px;
        }
        #contrib {
          font-family: 'Merriweather', serif;
          margin: auto;
          width: 60%;
          border: 3px solid #6495ED;
          padding: 10px;
          
        }
        #todo {
          font-family: 'Lora', serif;
          margin: auto;
          width: 60%;
          border: 3px solid #FFD700;
          padding: 10px;
        }
        #advert {
          margin: auto;
          width: 90%;
        }
        #disclaimer {
          font-family: 'Lora', serif;
          margin: auto;
          width: 60%;
          border: 3px solid #FF6347;
          padding: 10px;
          
        }
        #help {
          font-family: 'Lora', serif;
        }
        #sharethis {
          margin: auto;
          width: 60%;
          border: 3px solid #008B8B;
          padding: 10px;
          
        }
        </style>
      </head>
      <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
      <script type="text/javascript">stLight.options({publisher: "e688c392-bcd4-4559-a1c1-ef6d870c2593", doNotHash: false, doNotCopy: false, hashAddressBar: true});</script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      <script type="text/javascript">
      var TILE_SIZE = 256;

      //Mercator --BEGIN--
      function bound(value, opt_min, opt_max) {
        if (opt_min !== null) value = Math.max(value, opt_min);
        if (opt_max !== null) value = Math.min(value, opt_max);
        return value;
      }

      function degreesToRadians(deg) {
        return deg * (Math.PI / 180);
      }

      function radiansToDegrees(rad) {
        return rad / (Math.PI / 180);
      }

      function MercatorProjection() {
        this.pixelOrigin_ = new google.maps.Point(TILE_SIZE / 2,
          TILE_SIZE / 2);
        this.pixelsPerLonDegree_ = TILE_SIZE / 360;
        this.pixelsPerLonRadian_ = TILE_SIZE / (2 * Math.PI);
      }

      MercatorProjection.prototype.fromLatLngToPoint = function (latLng,
        opt_point) {
        var me = this;
        var point = opt_point || new google.maps.Point(0, 0);
        var origin = me.pixelOrigin_;

        point.x = origin.x + latLng.lng() * me.pixelsPerLonDegree_;

          // NOTE(appleton): Truncating to 0.9999 effectively limits latitude to
          // 89.189.  This is about a third of a tile past the edge of the world
          // tile.
          var siny = bound(Math.sin(degreesToRadians(latLng.lat())), - 0.9999,
            0.9999);
          point.y = origin.y + 0.5 * Math.log((1 + siny) / (1 - siny)) * -me.pixelsPerLonRadian_;
          return point;
        };

        MercatorProjection.prototype.fromPointToLatLng = function (point) {
          var me = this;
          var origin = me.pixelOrigin_;
          var lng = (point.x - origin.x) / me.pixelsPerLonDegree_;
          var latRadians = (point.y - origin.y) / -me.pixelsPerLonRadian_;
          var lat = radiansToDegrees(2 * Math.atan(Math.exp(latRadians)) - Math.PI / 2);
          return new google.maps.LatLng(lat, lng);
        };
      //Mercator --END--

      var desiredRadiusPerPointInMeters = 2000;
      function getNewRadius() {
        var numTiles = 1 << map.getZoom();
        var center = map.getCenter();
        var moved = google.maps.geometry.spherical.computeOffset(center, 10000, 90); /*1000 meters to the right*/
        var projection = new MercatorProjection();
        var initCoord = projection.fromLatLngToPoint(center);
        var endCoord = projection.fromLatLngToPoint(moved);
        var initPoint = new google.maps.Point(
          initCoord.x * numTiles,
          initCoord.y * numTiles);
        var endPoint = new google.maps.Point(
          endCoord.x * numTiles,
          endCoord.y * numTiles);
        var pixelsPerMeter = (Math.abs(initPoint.x-endPoint.x))/10000.0;
        var totalPixelSize = Math.floor(desiredRadiusPerPointInMeters*pixelsPerMeter);
        //console.log(totalPixelSize);
        return totalPixelSize;

      }

      var map, heatMap;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 1.3535514, lng: 103.8203601},
          zoom: 11,
          streetViewControl: false
        });

        heatMap = new google.maps.visualization.HeatmapLayer({
          maxIntensity: 300,
          radius: getNewRadius()
        });
        heatMap.setMap(map);

        google.maps.event.addListener(map, 'zoom_changed', function () {
          heatMap.setOptions({radius:getNewRadius()});
        });

        getPoints();
      }

      function getPoints() {
        var points = new Array();

        $.getJSON("https://script.google.com/macros/s/AKfycbzCOfcSRPOHmHltFv_jPKw0tq3q8TigA7FbklPvrxm9i-YlMyxX/exec", function (data) {
            var sampleData = data.readings;
            
            console.log("sampleData.length is " + sampleData.length);

            for (var i = 0; i < sampleData.length; i++) {
              var locationData = sampleData[i];
              console.log("locationData is " + locationData["value"]);

              var point = {};
              point.location = new google.maps.LatLng(locationData["lat"],locationData["long"]);
              point.weight = locationData["value"];

              console.log("pointData is " + JSON.stringify(point));

              points.push(point);

              var contentString = '<div id="content">'+
                '<h2 id="markerHeader" style="font-family: \'Arial\', serif;">' + locationData["location"] + '</h2>'+
                '<div id="markerContent">'+
                '<p>' + locationData["value"] + ' &#181;g/m<sup>3</sup></p>'+
                '</div>'+
                '</div>';

              var infowindow =  new google.maps.InfoWindow();
              var marker = new google.maps.Marker({
                position: point.location,
                map: map,
                title: ''
              });

              bindInfoWindow(marker,map,infowindow,contentString);
            }
          
          heatMap.setData(points);
        });
      };

      function bindInfoWindow(marker, map, infowindow, html) { 
          google.maps.event.addListener(marker, 'mouseover', function() {
              infowindow.setContent(html); 
              infowindow.open(map, marker); 

          });
          google.maps.event.addListener(marker, 'mouseout', function() {
              infowindow.close();

          }); 
      } 
      </script>
      <script async defer
      src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyBDwEEKk1ELCtXoHJBaERixXf8e_PuoYOw&callback=initMap&libraries=visualization,geometry">
      </script>
      <body>
        <p></p>
        <div id="advert" align="center">
          <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <!-- NeoCities Responsive -->
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-2975646198715997"
               data-ad-slot="2511908084"
               data-ad-format="auto"></ins>
          <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </div>
        <h1 align="center">Community Online Haze Index</h1>
        <div id='map'></div>
        <p></p>
        <div id="sharethis" align="center">
        <h2 align="center">Like this site? Spread the word!</h2>
        <span class='st_whatsapp_vcount' displayText='WhatsApp'></span>
        <span class='st_facebook_vcount' displayText='Facebook'></span>
        <span class='st_twitter_vcount' displayText='Tweet'></span>
        <span class='st_reddit_vcount' displayText='Reddit'></span>
        <span class='st_tumblr_vcount' displayText='Tumblr'></span>
        </div>
        <p>
          <div id='todo'>
            <h2 style="padding-left: 1em" >TODO List</h3>
              <ul>
                <li>Add NEA station readings</li>
                <li>Make site responsive</li>
                <li>Add MetOne source</li>
              </ul>
            </div>
            <p>
              <div id='contrib'>
                <h2 align="center">Special Thanks & Contributors</h3>
                  <div align="center">
                    <br>boink!
                    <br><a href="http://fuzzyview.neocities.org/">chuanz</a>
                  </div>
                  <br><div id="help" align="center">Wanna help out? Drop an email to <br><b>asphodeli &#x1F4E7;yahoo.com.sg</b></div>
                </div>
                <p></p>
                <div id='disclaimer'>
                <h2 align="center">Disclaimer</h3>
                  <div align="center">
                    THIS WEBSITE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS WEBSITE.
                    <p>The site administrator can be reached at <br><b>asphodeli &#x1F4E7;yahoo.com.sg</b></p>
                    </div>
                  </div>
                </div>
                <p>&nbsp;</p>
              </body>
              </html>